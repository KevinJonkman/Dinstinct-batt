# Known Issues - 28 January 2025

## CRITICAL: Hard Safety Stop Prevents Battery Recovery

### Problem Description
When battery voltage drops below 2.70V, the ESP32 triggers a "HARD STOP" which turns off the Delta PSU output. This is intended as a safety feature to prevent over-discharge.

**However**, this also prevents CHARGING a deeply discharged battery, because:
1. The hard stop triggers on ANY low voltage reading
2. Even when trying to charge (positive current), the system stops
3. This creates a situation where a battery below 2.70V cannot be recovered using the ESP32 system

### What We Tried
1. **First fix**: Added condition `i < -0.5` to only trigger when discharging
   - Code: `if (v > 0.5 && v < HARD_MIN_VOLTAGE && i < -0.5)`
   - **Result**: Still triggered hard stop (unclear why)

2. **Second fix**: Completely disabled low voltage hard stop
   - Commented out the entire block
   - **Result**: ESP32 communication became unstable, couldn't verify fix

### Current Status (v7.4)
- Low voltage hard stop is **DISABLED** (commented out)
- High voltage hard stop (>4.15V) is still active
- Battery needs to be charged externally to recover above 2.70V

### Symptoms When Issue Occurs
```
err: "HARD STOP: Voltage below 2.70V"
```
- Delta output turns off
- Test stops
- Cannot restart charging

### Root Cause Analysis Needed
1. Why did the `i < -0.5` condition not work?
   - Current measurement might be delayed
   - Initial current spike might be negative
   - Measurement noise?

2. ESP32-Delta communication issues
   - Frequent connection timeouts
   - Status queries failing
   - May be related to concurrent connections

### Workaround
1. Charge battery externally (not via ESP32) until voltage > 2.70V
2. Then use ESP32 system normally

### Files Modified
- `src/main.cpp` - Hard stop code commented out (lines 724-738)

### TODO for Tomorrow
1. Debug why current condition doesn't prevent hard stop
2. Add startup delay before enabling hard stop
3. Consider adding "recovery mode" that bypasses safety for charging only
4. Fix ESP32-Delta communication stability

---

## Secondary Issue: ESP32-Delta Communication Instability

### Symptoms
- `curl` requests timeout (exit code 56)
- Delta queries return empty/failed
- Status shows `delta: false` intermittently

### Possible Causes
- Delta SCPI port only accepts one connection at a time
- ESP32 and PowerShell scripts competing for connection
- Network congestion on local network

### Workaround
- Power cycle Delta PSU
- Ensure Delta is in REMOTE mode
- Don't run multiple queries simultaneously

---

## Test Results Before Issues

### Successful Wh Capacity Test (before hard stop issues)
- **Discharge**: 27.47 Ah / 99.3 Wh
- **Energy Density**: 312 Wh/kg (318g cell)
- **Comparison vs SGS**: +23% better

See: `2025-01-28_WhTest_12A.md` and `2025-01-28_discharge_graph.html`

---

*Last updated: 28 January 2025, ~evening*
*Battery currently being charged externally*
